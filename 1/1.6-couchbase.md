# 1.6 Couchbase 인덱스 및 데이터 디렉토리 탐색

디스크에 있는 인덱스 및 데이터 디렉토리에 무엇이 있는지 살펴보겠습니다.

```bash
[ec2-user@Couchbase01 ~]$ sudo ls -alh /opt/couchbase/var/lib/couchbase/indexes
```

출력:

```bash
total 8.0K
drwxrwx---.  6 couchbase couchbase   56 May  5 11:33 .
drwxr-xr-x.  8 couchbase couchbase 4.0K May  5 14:14 ..
drwxr-x---. 10 couchbase couchbase 4.0K May  5 12:18 @2i
drwxrwx---.  4 couchbase couchbase   84 May  5 12:17 .delete
drwxrwx---.  5 couchbase couchbase   65 May  5 12:17 @indexes
```

***



```bash
[ec2-user@ Couchbase01 ~]$ sudo ls -alh /opt/couchbase/var/lib/couchbase/indexes/@indexes
```

출력:

```bash
total 8.0K
drwxrwx---. 5 couchbase couchbase   65 May  5 12:17 .
drwxrwx---. 6 couchbase couchbase   56 May  5 11:33 ..
drwxrwx---. 3 couchbase couchbase 4.0K May  5 11:36 beer-sample
drwxrwx---. 2 couchbase couchbase   57 May  5 11:42 gamesim-sample
```

***



```bash
[ec2-user@ Couchbase01 ~]$ sudo ls -alh /opt/couchbase/var/lib/couchbase/indexes/@indexes/beer-sample
```

출력:

```bash
total 756K
drwxrwx---. 3 couchbase couchbase 4.0K May  5 11:36 .
drwxrwx---. 5 couchbase couchbase   65 May  5 12:17 ..
-rw-rw----. 1 couchbase couchbase 752K May  5 11:36 main_5a222b8c920aa5e3a28b51ee7eb609a0.view.1
drwxrwx---. 2 couchbase couchbase    6 May  5 11:36 tmp_5a222b8c920aa5e3a28b51ee7eb609a0_main
```

\
Couchbase의 뷰(View)는 Couchbase 데이터베이스에 저장된 정보를 처리하여 데이터의 인덱싱과 쿼리를 가능하게 합니다. 뷰는 뷰 내에서 정의된 형식과 구조에 따라 저장된 정보에 대한 인덱스를 생성합니다.

***



Couchbase의 뷰(View)는 Couchbase 데이터베이스에 저장된 정보를 처리하여 데이터의 인덱싱과 쿼리를 가능하게 합니다. 뷰는 뷰 내에서 정의된 형식과 구조에 따라 저장된 정보에 대한 인덱스를 생성합니다.

```bash
[ec2-user@ Couchbase01 ~]$ sudo ls -alh /opt/couchbase/var/lib/couchbase/data
```

출력:

```bash
total 160K
drwxrwx---.  6 couchbase couchbase   83 Jul 31 16:48 .
drwxr-xr-x. 10 couchbase couchbase 4.0K Jul 31 17:26 ..
drwxrwx---.  2 couchbase couchbase  28K Jul 31 17:26 beer-sample
drwxrwx---.  2 couchbase couchbase    6 Jul 31 16:37 .delete
drwxrwx---.  2 couchbase couchbase  28K Jul 31 17:25 gamesim-sample
drwxrwx---.  2 couchbase couchbase  28K Jul 31 17:26 travel-sample
```

***



```bash
[ec2-user@ Couchbase01 ~]$ sudo ls -alh /opt/couchbase/var/lib/couchbase/data/beer-sample
```

출력:

```bash
total 16M
drwxrwx---. 2 couchbase couchbase  28K May  5 14:18 .
drwxrwx---. 7 couchbase couchbase 4.0K May  5 12:16 ..
-rw-rw----. 1 couchbase couchbase  17K May  5 11:36 0.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1000.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1001.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1002.couch.1
-rw-rw----. 1 couchbase couchbase  13K May  5 11:36 1003.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1004.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1005.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1006.couch.1
-rw-rw----. 1 couchbase couchbase  13K May  5 11:36 1007.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1008.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1009.couch.1
-rw-rw----. 1 couchbase couchbase  13K May  5 11:36 100.couch.1
-rw-rw----. 1 couchbase couchbase  13K May  5 11:36 1010.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1011.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1012.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1013.couch.1
-rw-rw----. 1 couchbase couchbase 8.1K May  5 11:36 1014.couch.1
-rw-rw----. 1 couchbase couchbase  13K May  5 11:36 1015.couch.1
 <output truncated>
```

\
이 디렉토리에 30MB의 데이터가 있는 것을 확인하세요.

(참고: 여러분의 머신에서는 25\~35MB 사이일 수 있습니다)

\
이제 이 디렉토리 안의 파일 개수를 세어보세요:

```bash
[ec2-user@ Couchbase01 ~]$ sudo ls -al /opt/couchbase/var/lib/couchbase/data/beer-sample | wc -l
1030
```

약 1030개 항목이 표시될 것입니다. 여기에는 1024개의 `Couchbase 파티션(vBucket 파일)`과 백 인덱스, 메타데이터 파일 등이 포함됩니다.\


다음으로, beer-sample 데이터베이스의 vBucket 파일 중 하나를 확인하기 위해 `couch_dbdump` 명령을 실행합니다.

```bash
[ec2-user@ Couchbase01 ~]$ sudo /opt/couchbase/bin/couch_dbdump /opt/couchbase/var/lib/couchbase/data/beer-sample/0.couch.1 | head -20
```

\
출력:

```bash
Dumping "/opt/couchbase/var/lib/couchbase/data/beer-sample/0.couch.1":
Doc seq: 1
     id: lafayette_brewing-black_angus_oatmeal_stout
     rev: 1
     content_meta: 128
     size (on disk): 230
     cas: 1438282944544964608, expiry: 0, flags: 0, datatype: 1, conflict_resolution_mode: 0
     size: 233
     data: (snappy) {"name":"Black Angus Oatmeal Stout","abv":0.0,"ibu":0.0,"srm":0.0,"upc":0,"type":"beer","brewery_id":"lafayette_brewing","updated":"2010-07-22 20:00:20","description":"","style":"American-Style Stout","category":"North American Ale"}
Doc seq: 2
     id: el_toro_brewing_company
     rev: 1
     content_meta: 128
     size (on disk): 1496
     cas: 1438282944545030144, expiry: 0, flags: 0, datatype: 1, conflict_resolution_mode: 0
     size: 1826
     data: (snappy) {"name":"El Toro Brewing Company","city":"Morgan Hill","state":"California","code":"95037","country":"United States","phone":"408-782-2739","website":"http://www.eltorobrewing.com/","type":"brewery","updated":"2010-07-22 20:00:20","description":"Geno and Cindy Acevedo founded El Toro Brewing Company in the summer of 1992. After much planning, research and construction business was begun in March of 1994. The brewery is a small 17-barrel (527 gallon) batch system and operates on the Acevedo's rural residential property.  Within seven months of opening El Toro Brewing Company received its first national recognition at the 1994 Great American Beer Festival (GABF). One of its flagships El Toro Oro Golden Ale won a coveted Gold Medal for English Pale Ale. At the 1996 GABF Poppy Jasper Amber Ale, the brewery's other flagship beer, won a Silver Medal for English Brown Ale. It is a mild yet robust brown ale. The 1997 GABF saw El Toro garner another Gold Medal for the American styled wheat beer named after the brewer's father-in-law, William Jones Wheat Beer.  After 16 years of planning, Geno and Cindy Acevedo of Morgan Hill finally opened a brewpub on November 25 2006. El Toro Brewpub is a two floored building with patio. Inside is the world's only Poppy Jasper Bar. Featuring over 45 feet of gorgeously inlaid and polished Poppy Jasper rock into its surface. To the back of the large mirrored bar you will find over 25 beers and handcrafted sodas on tap. We also have a gleaming copper Pub Brewing system 3 BBL (100 gallon) brewery. Live music and dancing will also be a regular nighttime happening at the brewpub consisting of mostly local bands playing cover type and original Rock, Blues, Jazz and Reggae.","address":["17605 Monterey Road"],"geo":{"accuracy":"RANGE_INTERPOLATED","lat":37.1553,"lon":-121.676}}
Doc seq: 3
     id: st_austell_brewery-hsd_hicks_special_draught
     rev: 1
```

이 특정 데이터 파일에는 3개의 (부분) JSON 문서가 포함되어 있음을 확인하세요.



또한 `couch_dbinfo` 명령을 사용하여 데이터 파일에 대한 정보를 출력할 수도 있습니다.

```bash
[ec2-user@ Couchbase01 ~]$ sudo /opt/couchbase/bin/couch_dbinfo /opt/couchbase/var/lib/couchbase/data/beer-sample/0.couch.1
```

\
출력:

```bash
DB Info (/opt/couchbase/var/lib/couchbase/data/beer-sample/0.couch.1) - header at 16384
   file format version: 12
   update_seq: 9
   purge_seq: 0
   crc: CRC-32C
   doc count: 9
   deleted doc count: 0
   data size: 6.6 kB
   B-tree size: 1.2 kB
   total disk size: 16.1 kB
```



위 출력에는 이 데이터 파일의 문서 개수, 실제 데이터 크기, 그리고 **총 디스크 파일 크기(메타데이터 포함)**&#xAC00; 표시됩니다.

(총 디스크 파일 크기는 사용 중인 환경에 따라 24kB에서 40kB 사이로 달라질 수 있습니다.)

또한 삭제된 문서 개수도 표시되지만, 샘플 데이터베이스에는 현재 삭제된 문서가 없습니다.



### Linux에서의 시작(Startup)과 종료(Shutdown): 

Linux에서 Couchbase Server는 독립 실행형 애플리케이션으로 설치되며, 표준 제어 스크립트인 /etc/init.d/couchbase-server를 사용하여 시작 시 백그라운드(데몬) 프로세스로 실행됩니다. 이 시작 스크립트는 설치 과정에서 자동으로 설치됩니다.

기본적으로 Couchbase Server는 실행 레벨 2, 3, 4, 5에서 자동으로 시작되며, 실행 레벨 0, 1, 6에서 명시적으로 종료되도록 설정됩니다.

Couchbase Server를 systemctl을 사용해 수동으로 중지하려면:

```bash
[ec2-user@ Couchbase01 ~]$ sudo systemctl stop couchbase-server
```

\
**이제 웹 UI에서 서버와의 연결이 끊겼다는 메시지가 표시될 수 있습니다.**

\
Couchbase를 다시 시작하기 전에, Couchbase의 info 로그 파일을 확인해 보세요. root 권한으로 전환한 뒤 계속 진행합니다.

```bash
[ec2-user@ Couchbase01 ~]$ sudo -s
[root@Couchbase01 ec2-user] cd /opt/couchbase/var/lib/couchbase/logs
[root@Couchbase01 logs]# ls -alh
```

출력:

```bash
total 24M
drwxr-xr-x. 2 couchbase couchbase  4.0K Apr 19 22:44 .
drwxr-xr-x. 8 couchbase couchbase  4.0K Apr 19 22:44 ..
-rw-rw----. 1 couchbase couchbase  824K Apr 19 22:44 babysitter.log
-rw-rw----. 1 couchbase couchbase  726K Apr 19 22:44 couchdb.log
-rw-rw----. 1 couchbase couchbase    13 Apr 19 22:44 crash_log.bin
-rw-rw----. 1 couchbase couchbase     0 Apr 19 22:44 crash_log.bin.tmp
-rw-rw----. 1 couchbase couchbase  5.2M Apr 19 22:44 debug.log
-rw-rw----. 1 couchbase couchbase  8.9K Apr 19 22:44 error.log
-rw-rw----. 1 couchbase couchbase   19K Apr 19 22:44 goxdcr.log
-rw-rw----. 1 couchbase couchbase  529K Apr 19 22:44 http_access.log
-rw-rw----. 1 couchbase couchbase 1001K Apr 19 22:44 indexer.log
-rw-rw----. 1 couchbase couchbase  3.1M Apr 19 22:44 info.log
-rw-rw--    1 couchbase couchbase 0 Apr 19 17:35 mapreduce_errors.log
-rw-rw---   1 couchbase couchbase 2.4M Apr 19 22:44 memcached.log.0.txt
-rw-rw----. 1 couchbase couchbase  1.5M Apr 19 22:44 ns_couchdb.log
-rw-rw----. 1 couchbase couchbase  615K Apr 19 22:44 projector.log
-rw-rw----. 1 couchbase couchbase   637 Apr 19 22:44 query.log
-rw-rw----. 1 couchbase couchbase  276K Apr 19 22:44 reports.log
-rw-rw----. 1 couchbase couchbase  8.5K Apr 19 18:31 ssl_proxy.log
-rw-r--r--. 1 root      root          9 Apr 19 17:35 start.log
-rw-rw----. 1 couchbase couchbase  7.3M Apr 19 22:44 stats.log
-rw-rw----. 1 couchbase couchbase  107K Apr 19 21:45 views.log
-rw-rw----. 1 couchbase couchbase     0 Apr 19 17:35 xdcr_errors.log
-rw-rw----. 1 couchbase couchbase  1.2K Apr 19 18:31 xdcr.log
-rw-rw----. 1 couchbase couchbase     0 Apr 19 17:35 xdcr_trace.log
```



`tail` 명령을 사용하여 info 로그 파일의 마지막 21줄을 표시합니다.

```bash
[root@Couchbase01 logs] tail -21 info.log
```

```bash
"travel-sample"]
[ns_server:warn,2017-09-26T17:57:12.714Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2873.66>:ns_memcached:connect:1187]Unable to connect: {error,{badmatch,{error,closed}}}, retrying.
[ns_server:warn,2017-09-26T17:57:12.714Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2893.66>:ns_memcached:connect:1187]Unable to connect: {error,{badmatch,{error,closed}}}, retrying.
[ns_server:warn,2017-09-26T17:57:12.714Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2876.66>:ns_memcached:connect:1187]Unable to connect: {error,{badmatch,{error,closed}}}, retrying.
[ns_server:warn,2017-09-26T17:57:12.714Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2866.66>:ns_memcached:connect:1187]Unable to connect: {error,{badmatch,{error,closed}}}, retrying.
[ns_server:info,2017-09-26T17:57:12.735Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2.0>:ns_bootstrap:stop:42]Initiated server shutdown
[ns_server:info,2017-09-26T17:57:12.738Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:mb_master<0.6413.50>:mb_master:terminate:298]Synchronously shutting down child mb_master_sup
[ns_server:warn,2017-09-26T17:57:13.717Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2873.66>:ns_memcached:connect:1187]Unable to connect: {error,{badmatch,{error,econnrefused}}}, retrying.
[ns_server:warn,2017-09-26T17:57:13.717Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2893.66>:ns_memcached:connect:1187]Unable to connect: {error,{badmatch,{error,econnrefused}}}, retrying.
[ns_server:warn,2017-09-26T17:57:13.717Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2876.66>:ns_memcached:connect:1187]Unable to connect: {error,{badmatch,{error,econnrefused}}}, retrying.
[ns_server:info,2017-09-26T17:57:14.320Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:ns_couchdb_port<0.6096.50>:ns_port_server:log:223]ns_couchdb<0.6096.50>: 22183: got shutdown request. Exiting
ns_couchdb<0.6096.50>: [os_mon] memory supervisor port (memsup): Erlang has closed
ns_couchdb<0.6096.50>: [os_mon] cpu supervisor port (cpu_sup): Erlang has closed

[ns_server:info,2017-09-26T17:57:14.324Z,ns_1@ec2-54-183-85-83.us-west-1.compute.amazonaws.com:<0.2.0>:ns_bootstrap:stop:46]Successfully stopped ns_server
```



```bash
[root@Couchbase01 logs] exit
```

\
이 디렉토리의 나머지 로그들은 이후 실습에서 살펴볼 예정이지만, 나머지 로그에 어떤 내용이 포함되어 있는지 궁금하다면 다음 링크를 참고하세요:

https://docs.couchbase.com/server/current/manage/manage-logging/manage-logging.html

\
이제 Couchbase Server를 수동으로 다시 시작합니다.



```bash
[ec2-user@Couchbase01 ~]$ sudo systemctl start couchbase-server
```

\
서버를 명시적으로 종료한 뒤 다시 시작해야 하는 경우가 있을 수 있습니다. 일반적으로 서버가 일정 시간 동안 실행되고 디스크에 데이터가 저장된 상태에서 재시작하면, 서버는 데이터를 다시 제공하기 전에 웜업(warmup) 과정을 거쳐야 합니다.

웜업은 재시작된 서버가 데이터를 제공하기 전에 반드시 수행해야 하는 과정입니다. 이 과정에서 서버는 디스크에 저장된 항목을 RAM으로 로드합니다. 데이터를 로드하는 한 가지 방법은 디스크에서 RAM으로 항목을 순차적으로 로드하는 것이지만, 이 방식은 항목이 자주 사용되는지 여부를 고려하지 않기 때문에 효과적이지 않을 수 있습니다.

Couchbase Server는 웜업 과정에서 데이터를 더 빠르게 사용할 수 있도록 최적화 기능을 제공합니다. 특히 액세스 로그(access log)에서 자주 사용되는 항목을 우선시하여, 가장 많이 액세스된 키 목록을 미리 가져오고 나서 다른 항목을 디스크에서 불러옵니다.

웜업에 대해서는 이후 실습에서 더 자세히 다룰 예정입니다. 지금은 서버가 모든 항목을 RAM으로 완전히 로드하기 전에 \*\*준비 모드(ready mode)\*\*로 전환할 수도 있으며, 이로 인해 모든 항목이 로드되기 전에 데이터 제공을 시작할 수도 있다는 점만 알고 있으면 됩니다. 이 설정을 조정해 웜업 속도를 더 빠르게 만들 수도 있습니다.

마지막으로, status 명령을 실행하기 전에 Couchbase가 시작될 시간을 주기 위해 40초를 기다리세요.

```bash
[ec2-user@Couchbase01 ~]$ sudo systemctl status couchbase-server
```

```bash
couchbase-server.service - Couchbase Server
   Loaded: loaded (/usr/lib/systemd/system/couchbase-server.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2021-01-09 14:25:47 EST; 1 day 2h ago
     Docs: http://docs.couchbase.com
  Process: 9662 ExecStart=/opt/couchbase/bin/couchbase-server -- -noinput -detached (code=exited, status=0/SUCCESS)
 Main PID: 9734 (beam.smp)
   CGroup: /system.slice/couchbase-server.service
           ├─ 9674 /opt/couchbase/lib/erlang/erts-5.10.4.0.0.1/bin/epmd -daemon
           ├─ 9705 /opt/couchbase/lib/erlang/erts-5.10.4.0.0.1/bin/beam.smp -A 16 -- -root /opt/couchbase/lib/erlang -progname erl --...
           ├─ 9730 /opt/couchbase/bin/gosecrets
           ├─ 9734 /opt/couchbase/lib/erlang/erts-5.10.4.0.0.1/bin/beam.smp -A 16 -sbt u -P 327680 -K true -swt low -MMmcs 30 -e10240...
           ├─ 9762 sh -s disksup
           ├─ 9764 /opt/couchbase/lib/erlang/lib/os_mon-2.2.14/priv/bin/memsup
           ├─ 9765 /opt/couchbase/lib/erlang/lib/os_mon-2.2.14/priv/bin/cpu_sup
           ├─ 9766 inet_gethost 4
           ├─ 9767 inet_gethost 4
           ├─ 9817 /opt/couchbase/bin/saslauthd-port
           ├─ 9838 /opt/couchbase/bin/memcached -C /opt/couchbase/var/lib/couchbase/config/memcached.json
{output truncated…….}
Jan 10 16:40:47 Couchbase01 systemd[1]: Starting Couchbase Server...
Jan 10 16:40:49 Couchbase01 systemd[1]: PID file /opt/couchbase/var/lib/couchbase/couchbase-server.pid not readable (yet?) after start.
Jan 10 16:40:52 Couchbase01 systemd[1]: couchbase-server.service: Supervising process 16958 which is not our child. We'll most... exits.
Jan 10 16:40:52 Couchbase01 systemd[1]: Started Couchbase Server.
Hint: Some lines were ellipsized, use -l to show in full.
Type in q (for quit)

Then exit
```

\
`Started Couchbase Server` 메시지를 확인하세요.\


