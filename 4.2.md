# 4.2 클러스터에서 노드를 정상적으로 제거하고 다시 등록하기

Couchbase 클러스터 노드의 하드웨어를 업그레이드해야 해서 해당 노드를 클러스터에서 일시적으로 제거하고, 전원을 내려 하드웨어를 업그레이드한 뒤, 서버를 다시 시작해 클러스터에 재등록해야 한다고 가정해 보겠습니다.

이처럼 사전에 점검 일정을 계획할 수 있는 상황에서는 영향을 받는 노드를 제거(remove) → 리밸런스(rebalance) → 나중에 다시 추가(add) 하는 절차를 따라야 합니다.

이 섹션에서는 노드를 클러스터에서 제거하고 다시 클러스터에 추가하는 올바른 방법을 단계별로 살펴보겠습니다. 노드를 제거하고 클러스터를 리밸런스하는 동안 데이터 서비스가 중단되거나 데이터가 손실되는 일은 없습니다. 관리 목적으로 정상 노드를 제거해야 하는 경우에는 장애 조치(failover) 가 아니라 제거(remove) 와 리밸런스(rebalance) 기능을 사용해야 합니다.



## 1. cbworkloadgenerator 중지

App Server(AppServer 블랙 VM) 로 전환하여 CTRL + C를 눌러 cbworkloadgenerator를 중지합니다.

그러면 다음과 같은 메시지가 표시되고 명령줄로 돌아갑니다:

```bash
....................................^Cinterrupted.
[ec2-user@AppServer ~]$
```

Web UI에서 클러스터의 쓰기 작업이 초당 0건으로 줄어든 것을 확인할 수 있습니다.

<figure><img src=".gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>



## 2. 기본 버킷을 제외한 모든 버킷 삭제

Web UI로 전환한 뒤, 왼쪽 메뉴에서 Buckets을 클릭하고 beer-sample 버킷을 확장합니다.

<figure><img src=".gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

`beer-sample` 항목이 확장되면 Drop을 클릭합니다.

제거 팝업에서도 Drop Bucket을 클릭합니다.

<figure><img src=".gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>



몇 초 후에 버킷이 삭제됩니다.

이제 gamesim-sample 세부 정보를 확장한 뒤 Drop을 클릭합니다.

<figure><img src=".gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>



Click `Drop Bucket` on the Removing popup as well:

<figure><img src=".gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

`travel-sample` 세부 정보를 확장한 뒤 Drop을 클릭합니다. 제거 팝업에서도 Drop Bucket을 클릭합니다.

작업이 완료되면 default 버킷만 남게 되며, 이를 확장해 Flush 버튼을 표시합니다.

<figure><img src=".gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>



## 3. 기본 버킷 비우기

마지막으로 기본 버킷의 모든 내용을 삭제(Flush) 합니다. 단, 기본 버킷 자체는 삭제하지 않습니다! 기본 버킷을 확장한 뒤 Flush를 클릭합니다.

<figure><img src=".gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

버킷을 비우기(Flush) 전에 먼저 Flush 기능을 활성화해야 합니다(실습 2에서 설정했어야 합니다).

설정이 되어 있지 않다면, Edit 버튼을 클릭하고 Advanced settings로 이동한 뒤 아래로 스크롤해 Enable 옆의 체크박스를 선택하고 Save를 클릭합니다.



팝업에서도 `Flush Bucket`을 클릭합니다.

<figure><img src=".gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

이제 기본 버킷의 Item Count가 0으로 표시되는 것을 확인할 수 있습니다.

<figure><img src=".gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>





## 4. `default` 버킷에 부하 생성

App Server(AppServer 블랙 VM) 로 전환하여 기본 버킷에 대해 100% 쓰기 부하를 생성합니다.\
1백만 개의 고유 아이템, 아이템 크기 20바이트, 스레드 2개를 사용하고, 중단될 때까지 무한 루프로 실행합니다. 이 데이터는 약 150MB 분량의 고유 데이터입니다.

```
[ec2-user@AppServer ~]$ while true; do cbworkloadgen -n $NODE1:8091 -i 1000000 -r 1 -s 20 -t 2 -v; sleep 2; done
```

{% hint style="info" %}
이 명령어는 명령줄 히스토리(위/아래 화살표 키)에 남아 있으며, 필요 시 아이템 개수를 수정해 다시 실행할 수 있습니다.
{% endhint %}

Web UI를 새로고침하면 default 버킷의 Item Count가 증가하는 것을 확인할 수 있습니다.

최종적으로 Item Count는 100만 개에 도달하게 됩니다.

<figure><img src=".gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>



## 5. 데이터 노드 제거

페이지 오른쪽에서 Servers를 클릭하고 클러스터에서 네 번째 머신을 확인합니다. 이 머신은 Group 2에 있어야 합니다. 네 번째 머신이 목록의 마지막 서버일 필요는 없습니다. Cluster-IPs 스프레드시트를 사용해 네 번째 머신의 퍼블릭 호스트 이름을 이 목록의 머신 중 하나와 매칭합니다.

그런 다음 해당 머신에 대해 `Remove`를 클릭합니다.

<figure><img src=".gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

`Remove Server`를 클릭해 서버 제거를 확인합니다.

<div align="left"><figure><img src=".gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure></div>

이제 해당 노드가 제거를 완료하기 위해 `Rebalance`와 함께 표시됩니다.

<figure><img src=".gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>





## 6. 클러스터 리밸런스

4번째 노드는 리밸런스가 완료될 때까지 기술적으로 클러스터에서 제거되지 않습니다.

<figure><img src=".gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

주황색 `Rebalance` 버튼을 클릭합니다.

리밸런스 작업이 시작됩니다. 데이터가 약 150MB 정도인 버킷이 하나뿐이므로 리밸런스는 2분 이내에 완료될 것입니다.

<figure><img src=".gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

App Server(블랙 VM) 로 전환하면 다음과 같은 경고 메시지가 생성되는 것을 볼 수 있습니다:

```
2017-10-29 03:49:42,117: s0 warning: received NOT_MY_VBUCKET; perhaps the cluster is/was rebalancing; vbucket_id: 342, key: pymc832873, spec: http://ec2-54-183-85-83.us-west-1.compute.amazonaws.com:8091, host:port: ec2-13-57-48-149.us-west-1.compute.amazonaws.com:11210
2017-10-29 03:49:42,117: s2 warning: received NOT_MY_VBUCKET; perhaps the cluster is/was rebalancing; vbucket_id: 439, key: pymc859387, spec: http://ec2-54-183-85-83.us-west-1.compute.amazonaws.com:8091, host:port: ec2-13-57-48-149.us-west-1.compute.amazonaws.com:11210
```

리밸런스가 완료되면 위 경고 메시지는 더 이상 나타나지 않습니다.\
리밸런스가 끝나면 Servers 페이지에 5개의 노드만 표시됩니다.

<figure><img src=".gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>



## 7. 제거했던 노드를 클러스터에 다시 추가하기

&#x20;다음으로 브라우저에서 노드 4에 접속해 설정 시작 화면을 엽니다:

```
http://<node4>:8091
```

<figure><img src=".gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

`Join Existing Cluster`를 선택합니다.

클러스터와 조인할 노드 이름 모두에 대해 Amazon EC2 주소를 사용하도록 필요한 정보를 입력합니다.

Data service만 선택하고, 다른 모든 서비스는 선택 해제합니다.

<div align="left"><figure><img src=".gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure></div>

￼

인덱스 경로를 `/opt/couchbase/var/lib/couchbase/index`로 수정합니다.

그런 다음 Join Cluster를 클릭합니다.



## 8. 추가된 노드의 서버 그룹 설정

Servers 페이지에서 `GROUPS` 링크를 클릭하고 새로 추가된 노드를 Group 2로 이동합니다.

<figure><img src=".gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

<figure><img src=".gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>



UI는 다음과 같이 표시되어야 합니다:

<figure><img src=".gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

Apply Changes를 클릭합니다.

그런 다음 UI는 다음과 같이 표시됩니다:

<figure><img src=".gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>



## 9. 클러스터를 다시 리밸런스하기

\
Servers 페이지로 돌아갑니다. 4번째 노드가 Pending Add 상태인 것을 확인할 수 있습니다. Rebalance를 클릭합니다.

<figure><img src=".gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

2분 이내에 리밸런스 작업이 완료되며, 4번째 노드가 클러스터에 성공적으로 다시 추가됩니다.

<figure><img src=".gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>



## 10. App Server에서 `cbworkloadgen`을 중지합니다.

이 마지막 리밸런스 동안 App Server의 cbworkloadgen 애플리케이션은 계속 실행되고 있는 것을 확인할 수 있습니다.

```
2017-10-29 04:02:47,923: s0 warning: received NOT_MY_VBUCKET; perhaps the cluster is/was rebalancing; vbucket_id: 683, key: pymc482114, spec: http://ec2-54-183-85-83.us-west-1.compute.amazonaws.com:8091, host:port: ec2-52-53-173-24.us-west-1.compute.amazonaws.com:11210
2017-10-29 04:02:47,923: s0 warning: received NOT_MY_VBUCKET; perhaps the cluster is/was rebalancing; vbucket_id: 683, key: pymc482666, spec: http://ec2-54-183-85-83.us-west-1.compute.amazonaws.com:8091, host:port: ec2-52-53-173-24.us-west-1.compute.amazonaws.com:11210
2017-10-29 04:02:47,934: s0 refreshing sink map: http://ec2-54-183-85-83.us-west-1.compute.amazonaws.com:8091
2017-10-29 04:02:47,938: s0 Starting new HTTP connection (1): ec2-54-183-85-83.us-west-1.compute.amazonaws.com
2017-10-29 04:02:48,001: s1 warning: received NOT_MY_VBUCKET; perhaps the cluster is/was rebalancing; vbucket_id: 683, key: pymc492819, spec: http://ec2-54-183-85-83.us-west-1.compute.amazonaws.com:8091, host:port: ec2-52-53-173-24.us-west-1.compute.amazonaws.com:11210error: MCSink exception:
```

App Server 창에서 루프를 중지하려면 다음을 수행합니다:

```
[ec2-user@appserver ~]$ [Cntrl] + [z] (keys to background process)
[ec2-user@appserver ~]$ ps –elf (to identify cbworkloadgen process id)
```

출력:

```
UID       PID     PPID
ec2-user  24193   22920
```

```
[ec2-user@appserver ~]$ kill -9 24193
```

