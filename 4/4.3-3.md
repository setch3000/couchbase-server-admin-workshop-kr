# 4.3 클러스터에서 노드 #3 제거

클러스터의 노드가 데이터를 제공할 수 없는 경우, 해당 노드를 장애 조치(Failover) 할 수 있습니다. 장애 조치란 Couchbase Server가 클러스터에서 해당 노드를 제거하고, 다른 노드에 있는 복제 데이터를 클라이언트 요청에 사용할 수 있도록 하는 것을 의미합니다. Couchbase에서 충분한 수의 복제본을 구성해두면, 클러스터는 하나 이상의 노드 장애가 발생하더라도 저장된 데이터에 대한 액세스에 영향을 주지 않고 이를 처리할 수 있습니다. 장애 조치는 Web UI, REST API 또는 Couchbase CLI를 통해 수동으로 시작할 수 있습니다.

또한 Couchbase Server를 구성하여 장애가 발생한 노드를 클러스터에서 자동으로 제거하고 클러스터가 축소된 모드로 작동하도록 할 수도 있습니다. 그러나 이 자동 옵션을 사용하면, 클러스터에 남아 있는 정상 노드들의 워크로드가 증가하게 됩니다. 여전히 노드 장애를 해결하고, 정상 노드를 클러스터에 복구한 후, 클러스터를 리밸런스 해야 장애 발생 전 상태로 돌아갈 수 있습니다. 어떤 분산 시스템에서든 장애를 자동으로 처리하도록 구성하면 예기치 못한 문제가 발생할 수 있습니다. 장애 원인을 파악하지 못하거나 남아 있는 시스템에 가해질 부하를 이해하지 못한다면, 자동 장애 조치는 문제를 해결하기보다는 더 많은 문제를 일으킬 수 있습니다.

정상적으로 작동 중인 노드를 장애 조치하려 하면 데이터 손실이 발생할 수도 있습니다. 장애 조치는 클러스터에서 해당 노드를 즉시 제거하고, 다른 노드에 복제되지 않았거나 디스크에 저장되지 않은 데이터는 영구적으로 손실될 수 있기 때문입니다.

장애 조치는 노드 제거(Remove)나 리밸런스(Rebalance)와는 다른 작업임을 유의해야 합니다. 일반적으로 정상 노드를 제거하는 것은 유지보수 등의 이유 때문이며, 장애 조치는 작동하지 않는 노드를 처리하기 위한 것입니다. 정상적인 노드를 관리 목적으로 제거하려면 장애 조치가 아니라 Remove와 Rebalance 기능을 사용해야 합니다.

실제 장애 조치를 실행하기 전에, 기본 버킷의 설정과 구성, 그리고 vBucket이 저장되는 위치 및 실습 클러스터에서 자동 장애 조치(autoFailover) 가 켜져 있는지 확인해 보겠습니다.



## 1.  노드 1의 vBucket 개수 확인

App 서버(Black VM)에서 1번 노드의 퍼블릭 호스트 이름을 사용하여 cbstats 명령어를 실행하고 active\_num을 grep으로 확인합니다:



```
[ec2-user@AppServer ~]$ cbstats $NODE1:11210 all -u Administrator -p couchbase -b default | grep active_num
```

```
 vb_active_num:                      256
 vb_active_num_non_resident:           0
```



## 2. 노드 2의 vBucket 개수 확인

2번 노드의 퍼블릭 호스트 이름(Cluster-IPs 스프레드시트에서 확인)을 사용해 동일한 명령어를 실행해 보십시오:

```
[ec2-user@AppServer ~]$ cbstats $NODE2:11210 all -u Administrator -p couchbase -b default | grep active_num
```

```
 vb_active_num:                                         256
 vb_active_num_non_resident:                            0
```

```
[ec2-user@appserver ~]$ cbstats $NODE2:11210 all -u Administrator -p couchbase -b default | grep replica_num
```

```
 vb_replica_num:                                        0
 vb_replica_num_non_resident:                           0
```

2번 노드에서도 active-num이 256으로 표시되는 것을 확인할 수 있습니다.

기본 버킷에 대해 복제본이 구성되지 않았기 때문에, 우리는 Rack Awareness/Server Groups 기능을 사용하여 복제 vBucket을 다른 서버 그룹에 분산하지 않고 있다는 점을 유의하세요.



## 3. 기본 버킷의 복제본 활성화

이제 Web UI로 전환하여 기본 버킷에 대해 1개의 복제본을 활성화해 보겠습니다. 하지만 먼저 기본 버킷을 플러시(Flush)하여 안에 있는 모든 데이터를 삭제해야 합니다.

Web UI 왼쪽 메뉴에서 Buckets를 클릭하고, 버킷의 Items 개수를 확인한 뒤(스크린샷의 숫자와는 다를 수 있음), Flush를 클릭합니다.

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

팝업에서도 `Flush`를 클릭합니다.

<div align="left"><figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure></div>



