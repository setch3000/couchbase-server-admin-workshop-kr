# 4.5 Node #4를 Failover

## 1. Node #4에서 Couchbase 서버 중지

이제 4번째 노드에서 Couchbase 서비스를 중지하여 서버 그룹 #2의 모든 서버가 해제되도록 하겠습니다.

4번째 노드(Yellow VM)의 PuTTY 창으로 전환한 뒤, 해당 노드에서 Couchbase 서비스를 중지하세요. 아래 명령어를 실행하여 Couchbase를 중지하고 상태를 확인하세요.

```bash
[ec2-user@Couchbase04 ~]$ sudo systemctl stop couchbase-server

[ec2-user@Couchbase04 ~]$ sudo systemctl status couchbase-server
```

출력:

```
Aug 10 13:53:09 node4 systemd[1]: Stopped LSB: couchbase server.
```

\


이번에는 Couchbase CLI를 사용하여 Node #4를 페일오버하겠습니다. App Server(검은색 VM)로 전환하세요.

아래 Couchbase CLI 페일오버 명령어를 실행하여 Node #4(노란색 VM)를 페일오버합니다. 이 명령어에서 두 개의 공용 호스트 이름이 사용됩니다.

* \--cluster 호스트 이름에는 Node #1의 공용 호스트 이름을 사용하세요.
* \--server-failover 호스트 이름에는 Node #4의 공용 호스트 이름을 사용하세요.

```bash
[ec2-user@AppServer ~]$ couchbase-cli failover --cluster=$NODE1:8091 --server-failover=$NODE4:8091 --hard
```

출력:

```
SUCCESS: Server failed over
```



모든 변수를 명령줄에서 지정해야 하는 경우, 명령어는 다음과 같이 표시됩니다:

```bash
[ec2-user@appserver ~]$ couchbase-cli failover \
  --cluster=http://ec2-54-183-85-83.us-west-1.compute.amazonaws.com:8091 \
  --server-failover=ec2-13-56-207-54.us-west-1.compute.amazonaws.com:8091 \
  --username=Administrator \
  --password=couchbase \
  --hard
```

\
성공 메시지가 표시되면 웹 UI로 전환하세요. 그러면 노드 #4가 Down 상태로 표시되고 Rebalance가 대기 중인 것을 확인할 수 있습니다.

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>



## 2. 클러스터를 리밸런스하세요.

App Server의 명령줄로 다시 전환하여 Couchbase CLI를 사용해 리밸런스 작업을 실행하세요.

(참고: --cluster 매개변수에는 Node #1의 공용 호스트 이름을, --server-remove 매개변수에는 제거하려는 노드인 Node #4의 공용 호스트 이름을 입력해야 합니다.)

또한… 다음 두 명령어를 몇 초 간격으로 실행하세요. 하나는 App Server에서, 다른 하나는 Node #1에서 실행합니다. (명령어를 실행하기 전에 각 VM에서 미리 입력해두면 좋습니다.)

```bash
[ec2-user@appserver ~]$ couchbase-cli rebalance --cluster=$NODE1:8091 --server-remove=$NODE4:8091
```

```
Rebalancing
Bucket: 00/00 ()                                                                                                               0 docs remaining
[=============================================================] 100.0%
SUCCESS: Rebalance complete
```

리밸런스가 실행되는 동안, 빠르게 Node #1(진한 파란색)으로 전환한 뒤 다음 명령어를 실행하여 리밸런스 작업의 상태를 확인하세요.

```bash
[ec2-user@couchbase01 ~]$ couchbase-cli rebalance-status --cluster=$NODE1:8091
```

출력 결과에서 progress 필드를 확인하세요:

```json
{
  "status": "running",
  "msg": "Rebalance is running",
  "details": {
    "totalBuckets": 1,
    "curBucket": 1,
    "refresh": 0.25,
    "docsRemaining": 14,
    "curBucketName": "default",
    "progress": 1.326701539572522
  }
}
```

\


```bash
[ec2-user@couchbase01 ~]$ couchbase-cli rebalance-status --cluster=$NODE1:8091
```

이제 progress 필드에 10.73%가 표시됩니다:

```json
{
  "status": "running",
  "msg": "Rebalance is running",
  "details": {
    "totalBuckets": 1,
    "curBucket": 1,
    "refresh": 0.25,
    "docsRemaining": 10,
    "curBucketName": "default",
    "progress": 10.73084561083574
  }
}
```



```bash
[ec2-user@couchbase01 ~]$ couchbase-cli rebalance-status --cluster=$NODE1:8091
```

이제 progress 필드에 24%가 표시됩니다:

```json
{
  "status": "running",
  "msg": "Rebalance is running",
  "details": {
    "totalBuckets": 1,
    "curBucket": 1,
    "refresh": 0.25,
    "docsRemaining": 6,
    "curBucketName": "default",
    "progress": 24.36932829664365
  }
}
```





```bash
[ec2-user@couchbase01 ~]$ couchbase-cli rebalance-status --cluster=$NODE1:8091
```

이제 progress 필드에 **33**%가 표시됩니다:

```json
{
  "status": "running",
  "msg": "Rebalance is running",
  "details": {
    "totalBuckets": 1,
    "curBucket": 1,
    "refresh": 0.25,
    "docsRemaining": 6,
    "curBucketName": "default",
    "progress": 33.09052558450966
  }
}
```





```bash
[ec2-user@couchbase01 ~]$ couchbase-cli rebalance-status --cluster=$NODE1:8091
```

이제 progress 필드에 **42**%가 표시됩니다:

```json
{
  "status": "running",
  "msg": "Rebalance is running",
  "details": {
    "totalBuckets": 1,
    "curBucket": 1,
    "refresh": 0.25,
    "docsRemaining": 2,
    "curBucketName": "default",
    "progress": 42.37983587338805
  }
}
```



```bash
[ec2-user@couchbase01 ~]$ couchbase-cli rebalance-status --cluster=$NODE1:8091
```

```json
{
  "status": "notRunning",
  "msg": "Rebalance is not running",
  "details": {}
}
```



좋습니다. 리밸런스 작업이 확실히 완료되었습니다. 웹 UI에서도 해당 변경 사항이 반영되어 있을 것입니다.

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

웹 UI에서 이제 서버 그룹 #1의 남아 있는 두 노드 각각에 5개의 활성 항목과 5개의 복제 항목(또는 6/4일 수도 있음)이 있는 것을 확인하세요.



## 3. 남아 있는 노드들의 vBucket 수를 확인하세요.

App Server(검은색 VM)에서 cbstats 명령어를 실행하고 첫 번째 노드의 공용 호스트 이름을 입력하세요.

```bash
[ec2-user@AppServer ~]$ cbstats $NODE1:11210 all -u Administrator -p couchbase -b default | grep active_num
```

출력:

```
 vb_active_num:                      512
 vb_active_num_non_resident:         0
```



\
\[ec2-user@AppServer \~]$ cbstats $NODE1:11210 all -u Administrator -p couchbase -b default | grep replica\_num

출력:

```
 vb_replica_num:                     512
 vb_replica_num_non_resident:        0
```

\
리밸런스 작업이 남아 있는 두 노드 각각에 512개의 활성 vBucket과 512개의 복제 vBucket을 배치한 것을 확인할 수 있습니다.

마지막으로, 전체 서버 그룹이 손실된 후에도 우리가 처음에 삽입한 10개의 키가 여전히 사용 가능한지 확인하기 위해 쿼리를 실행해 보세요. 나머지 모든 명령은 App Server에서 실행하고 첫 번째 노드의 공용 호스트 이름을 입력하면 됩니다.

```bash
[ec2-user@appserver ~]$ cbc-cat key-1 key-2 key-3 key-4 key-5 key-6 key-7 key-8 key-9 key-10
```

\
출력:

```
key-3                CAS=0x158dbe323e320000, Flags=0x0, Size=7, Datatype=0x00
value-3
key-4                CAS=0x158dbe37fe890000, Flags=0x0, Size=7, Datatype=0x00
value-4
key-6                CAS=0x158dbe4065800000, Flags=0x0, Size=7, Datatype=0x00
value-6
key-9                CAS=0x158dbe4c2b3f0000, Flags=0x0, Size=7, Datatype=0x00
value-9
key-10               CAS=0x158dbe4f7deb0000, Flags=0x0, Size=8, Datatype=0x00
value-10
key-1                CAS=0x158dbe1058080000, Flags=0x0, Size=7, Datatype=0x00
value-1
key-2                CAS=0x158dbe2f32620000, Flags=0x0, Size=7, Datatype=0x00
value-2
key-5                CAS=0x158dbe3cb8ce0000, Flags=0x0, Size=7, Datatype=0x00
value-5
key-7                CAS=0x158dbe43625d0000, Flags=0x0, Size=7, Datatype=0x00
value-7
key-8                CAS=0x158dbe46c9f60000, Flags=0x0, Size=7, Datatype=0x00
value-8
```

```bash
[ec2-user@appserver ~]$ cbc-cat key-11
```

\
출력:

```
key-11               LCB_KEY_ENOENT (0x0D)
```

\
위 출력에서 10개의 키가 모두 성공적으로 조회된 것을 확인할 수 있습니다. 만약 키를 찾을 수 없었다면(예: key-11), LCB\_KEY\_ENOENT 오류 메시지가 표시되었을 것입니다.



## 4. 노드 #3과 #4를 클러스터에 다시 조인

노드 #3과 #4를 클러스터에 다시 조인해봅시다. 방법이 기억나시나요?





수고하셨습니다.
