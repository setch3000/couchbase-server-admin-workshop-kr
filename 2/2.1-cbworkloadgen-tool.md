# 2.1 cbworkloadgen Tool 활용

cbworkloadgen은 무작위 데이터를 생성하고 Couchbase Server에 대해 읽기/쓰기 작업을 수행하는 도구입니다. 이 도구는 기본적인 테스트 기능을 제공하지만, 실제 환경에서의 성능이나 부하 테스트용으로 설계된 것은 아닙니다.

이 도구에는 읽기(get)와 쓰기(set) 작업의 비율, 삽입되는 문서의 개수와 크기, 그리고 동시에 실행되는 워커 스레드 수를 조정할 수 있는 옵션이 있습니다.

Linux에서는 이 도구가 다음 위치에 있습니다:

```
/opt/couchbase/bin/cbworkloadgen
```

이제 cbworkloadgen을 사용해 클러스터에 무작위 데이터를 삽입하여 Couchbase Server 설치를 테스트해보겠습니다.



### 1. `cbworkloadgen` 명령어 <a href="#id-1_code_cbworkloadgen_code_command" id="id-1_code_cbworkloadgen_code_command"></a>

```bash
[ec2-user@Couchbase01 ~]$ cbworkloadgen --help
```

출력:

```bash
Usage: cbworkloadgen [options]

Generate workload to destination.

Examples:
  cbworkloadgen -n localhost:8091
  cbworkloadgen -n 10.3.121.192:8091 -r .9 -i 100000 \
         -s 100 -b my-other-bucket --threads=10
Options:
  -h, --help            show this help message and exit
  -r .95, --ratio-sets=.95
                        set/get operation ratio
  -n 127.0.0.1:8091, --node=127.0.0.1:8091
                        node's ns_server ip:port
  -b default, --bucket=default
                        insert data to a different bucket other than default
  --ssl                 Transfer data with SSL enabled
  -i 10000, --max-items=10000
                        number of items to be inserted
  -s 10, --size=10      minimum value size
  --prefix=pymc         prefix to use for memcached keys or json ids
  -j, --json            insert json data
  -l, --loop            loop forever until interrupted by users
  -u USERNAME, --username=USERNAME
                        REST username for cluster or server node
  -p PASSWORD, --password=PASSWORD
                        REST password for cluster or server node
  -t 1, --threads=1     number of concurrent workers
  -v, --verbose         verbose logging; more -v's provide more verbosity
  --low-compression     generate document data that is difficult to compress
  --xattr               generate extended attributes for inserted documents
```

\


### 2. default라는 이름의 새 버킷을 추가합니다.

Buckets 링크 페이지에서 `ADD BUCKET` 링크를 선택합니다.

<figure><img src="../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>



\+ 팝업 창에서 다음 세부 정보를 입력합니다:

<figure><img src="../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>



다음 내용을 추가합니다(반드시 소문자 사용):

* Name: default
* Memory Quota: 100 MB



이후 `Advanced bucket settings`를 클릭합니다.

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>



`Replicas enabled` 박스의 선택을 해제합니다.

<figure><img src="../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

마지막으로 `Flush Enable` 박스를 선택합니다.

<figure><img src="../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>



`Add Bucket`을 클릭합니다.



### 3. `cbworkloadgen 실행`          <a href="#id-3_executing_code_cbworkloadgen_code" id="id-3_executing_code_cbworkloadgen_code"></a>

localhost, 사용자 이름, 비밀번호를 사용하여 `cbworkloadgen`을 실행합니다.\


```bash
[ec2-user@Couchbase01 ~]$ cbworkloadgen -n $NODE1:8091
```

```
[####################] 100.0% (10527/estimated 10526 msgs)
bucket: default, msgs transferred...
       :                total |       last |    per sec
 byte  :               105270 |     105270 |    217014.8
done
```

cbworkloadgen의 기본 설정은 Couchbase에 10,000개 항목을 삽입합니다.

명령줄에서 사용자 이름과 비밀번호를 입력할 필요가 없습니다. 이미 환경 변수로 설정했기 때문에 -u Administrator -p couchbase 옵션을 생략할 수 있습니다.



브라우저 창으로 전환하여 Couchbase Web UI 콘솔에 다시 연결합니다. 필요하다면 다시 로그인해야 할 수도 있습니다.

사이드 메뉴에서 Buckets 링크를 클릭하면, 이제 default 버킷의 items 열에 10,000개 항목이 있는 것을 확인할 수 있습니다.

<figure><img src="../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>



PuTTY 또는 터미널 창으로 돌아가서 cbworkloadgen을 실행해 크기 10바이트의 항목 500,000개를 삽입하고, 작업의 `50%를 쓰기(write)`로 설정합니다.

```bash
[ec2-user@Couchbase01 ~]$ cbworkloadgen -n $NODE1:8091 -i 500000 -r .5 -s 10
```

출력:

```bash
2017-09-26 19:41:06,474: s0 backing off, secs: 0.1000000 msgs)
2017-09-26 19:41:07,416: s0 backing off, secs: 0.1000000 msgs)
  [####################] 100.0% (999999/estimated 1000000 msgs)
bucket: default, msgs transferred...
             :                total |       last |    per sec
 byte        :              9999990 |    9999990 |   332161.2
 retry_batch :                    2 |          2 |        0.1
done
```

\
위 명령은 실행하는 데 약 30\~35초가 걸립니다. 이 작업이 실행되는 동안 바로 다음 단계들을 진행하세요.

먼저 Couchbase Web UI를 새로고침하면 default 버킷에 더 많은 항목이 추가된 것을 확인할 수 있습니다.\


<figure><img src="../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>



화면 왼쪽의 Dashboard 링크를 클릭합니다:

* 드롭다운 메뉴에서 Cluster overview 선택
* 기간은 minute으로 설정
* 모든 서버 노드에서 default 버킷 선택



<figure><img src="../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>



### 4. 위 그래프에서 `Total Ops ops`를 확인합니다:

초당 작업(operations per second)을 확인합니다. 사용 중인 클라우드 환경에 따라 초당 작업 수의 범위는 달라질 수 있습니다.&#x20;

더 자세한 성능 그래프를 보려면, 왼쪽의 Server 링크를 클릭한 다음 페이지 오른쪽의 해당 서버의 Statistics 링크를 클릭합니다.

<figure><img src="../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>



default 버킷을 선택하면 결과 페이지는 다음과 같이 표시됩니다:

<figure><img src="../.gitbook/assets/image (28).png" alt=""><figcaption></figcaption></figure>



이 그래프들은 이후 성능 실습에서 자세히 살펴볼 예정입니다.

지금은 명령줄(cmd-line)로 돌아가 `cbworkloadgen` 도구의 실행이 완료되었는지 확인하세요.

```bash
[####################] 100.0% (999999/estimated 1000000 msgs)
bucket: default, msgs transferred...
       :                total |       last |    per sec
 byte  :              9999990 |    9999990 |    253711.0
```



이 도구가 default 버킷에 초당 253711.0바이트의 I/O를 수행한 것을 확인하세요.

(작업 중인 VM의 vCPU와 메모리에 따라 숫자는 달라질 수 있습니다.)

\
총 1,000,000(백만) 개의 작업이 수행되었는데, 이는 우리가 500,000개의 새 항목을 삽입하고 삽입(set) 작업을 전체 비율의 `50%`로 설정했기 때문에 당연한 결과입니다.

